{% trans_default_domain 'locationview' %}

{% import _self as tab %}

{% block tab_content %}
    {{ form(schedule_form) }}
    {% for schedule_block in schedule_blocks %}
        <h2>Schedule Block {{ schedule_block.getId() }}</h2>
        {% set snapshots = schedule_block.getAttribute('snapshots').getValue %}
        {% set events = schedule_block.getAttribute('events').getValue %}
        {% set slots = schedule_block.getAttribute('slots').getValue %}
        {% set loaded_snapshot = schedule_block.getAttribute('loaded_snapshot').getValue %}

        <section class="ez-view-rawcontentview">
            <div class="ez-raw-content-title d-flex justify-content-between mb-3">
                <h2>
                    <a data-toggle="collapse" href=".ez-content-slots-collapse" class="ez-content-preview-toggle" aria-expanded="true">
                        Slots ({{ slots|length }})
                    </a>
                </h2>

            </div>
            <div class="ez-content-slots-collapse collapse show" style="">
                <section class="ez-fieldgroup container">
                    <table class="table">
                        <thead>
                        <tr>
                            <th></th>
                            <th>ID</th>
                            <th>Addition Date</th>
                            <th>Content</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for slot in slots %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ slot.id }}</td>
                                <td>
                                    {% if slot.item is not null %}
                                        {{ slot.item.additionDate|ez_full_datetime }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if slot.item is not null %}
                                        {{ ez_content_name(slot.item.location.contentInfo) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </section>
            </div>


            <div class="ez-raw-content-title d-flex justify-content-between mb-3">
                <h2>
                    <a data-toggle="collapse" href=".ez-content-loaded-snapshot-collapse" class="ez-content-preview-toggle" aria-expanded="true">
                        Loaded Snapshot ({% if loaded_snapshot is not null %}{{ loaded_snapshot.date|ez_full_datetime }}){% endif %}
                    </a>
                </h2>

            </div>
            <div class="ez-content-loaded-snapshot-collapse collapse show" style="">
                {% if loaded_snapshot is not null %}
                    <section class="ez-fieldgroup container">
                        <table class="table">
                            <thead>
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>Addition Date</th>
                                <th>Content</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for initial_item in loaded_snapshot.initialItems  %}
                                <tr>
                                    <td class="ez-table__cell">
                                        {{ loop.index }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {{ initial_item.id }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {{ initial_item.additionDate|ez_full_datetime }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {{ ez_content_name(initial_item.location.contentInfo) }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>


                        <h3>Events applied after loading snapshot:</h3>
                        <table class="table">
                            <thead>
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Content</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for event in applied_events[schedule_block.id] %}
                                {% set event_content = '' %}
                                {% set bg = '#ffffff' %}

                                {% if event.type == 'itemAdded' %}
                                    {% set bg = '#ddffcc' %}
                                {% elseif event.type == 'itemRemoved' %}
                                    {% set bg = '#ffcccc' %}
                                {% elseif event.type == 'itemsReordered' %}
                                    {% set bg = '#e6f2ff' %}
                                {% elseif event.type == 'limitChanged' %}
                                    {% set bg = '#ffe6ff' %}
                                {% endif %}

                                <tr style="background: {{ bg }}">
                                    <td class="ez-table__cell">
                                        {{ loop.index }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {{ event.type }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {{ event.id }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {{ event.datetime|ez_full_datetime }}
                                    </td>
                                    <td class="ez-table__cell">
                                        {% if event.type == 'itemAdded' %}
                                            {{ ez_content_name(event.item.location.contentInfo) }}
                                        {% elseif event.type == 'itemRemoved' %}
                                            {{ ez_content_name(items[schedule_block.id][event.itemId].location.contentInfo) }}
                                        {% elseif event.type == 'itemsReordered' %}
                                            <ol>
                                                {% for itemId in event.map %}
                                                    <li>{{ ez_content_name(items[schedule_block.id][itemId].location.contentInfo) }}</li>
                                                {% endfor %}
                                            </ol>
                                        {% elseif event.type == 'limitChanged' %}
                                            {{ event.limit }}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                    </section>
                {% else %}
                    No snapshot loaded.
                {% endif %}
            </div>

            <div class="ez-raw-content-title d-flex justify-content-between mb-3">
                <h2>
                    <a data-toggle="collapse" href=".ez-content-events-collapse" class="ez-content-preview-toggle" aria-expanded="true">
                        Events ({{ events|length }})
                    </a>
                </h2>

            </div>
            <div class="ez-content-events-collapse collapse" style="">
                <section class="ez-fieldgroup container">

                    <table class="table">
                        <thead>
                        <tr>
                            <th></th>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Content</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for event in events %}
                            {% set event_content = '' %}
                            {% set bg = '#ffffff' %}

                            {% if event.type == 'itemAdded' %}
                                {% set bg = '#ddffcc' %}
                            {% elseif event.type == 'itemRemoved' %}
                                {% set bg = '#ffcccc' %}
                            {% elseif event.type == 'itemsReordered' %}
                                {% set bg = '#e6f2ff' %}
                            {% elseif event.type == 'limitChanged' %}
                                {% set bg = '#ffe6ff' %}
                            {% endif %}

                            <tr style="background: {{ bg }}">
                                <td class="ez-table__cell">
                                    {{ loop.index }}
                                </td>
                                <td class="ez-table__cell">
                                    {{ event.type }}
                                </td>
                                <td class="ez-table__cell">
                                    {{ event.id }}
                                </td>
                                <td class="ez-table__cell">
                                    {{ event.datetime|ez_full_datetime }}
                                </td>
                                <td class="ez-table__cell">
                                    {% if event.type == 'itemAdded' %}
                                        {{ ez_content_name(event.item.location.contentInfo) }}
                                    {% elseif event.type == 'itemRemoved' %}
                                        {{ ez_content_name(items[schedule_block.id][event.itemId].location.contentInfo) }}
                                    {% elseif event.type == 'itemsReordered' %}
                                        <ol>
                                            {% for itemId in event.map %}
                                                <li>{{ ez_content_name(items[schedule_block.id][itemId].location.contentInfo) }}</li>
                                            {% endfor %}
                                        </ol>
                                    {% elseif event.type == 'limitChanged' %}
                                        {{ event.limit }}
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </section>
            </div>

            <div class="ez-raw-content-title d-flex justify-content-between mb-3">
                <h2>
                    <a data-toggle="collapse" href=".ez-content-preview-collapse" class="ez-content-preview-toggle" aria-expanded="true">
                        Snapshots ({{ snapshots|length }})
                    </a>
                </h2>
            </div>
            <div class="ez-content-preview-collapse collapse show" style="">
                <section class="ez-fieldgroup container">
                    {% for snapshot in snapshots %}
                    <div class="ez-content-field">
                        <p class="ez-content-field-name">#{{ loop.index }}: {{ snapshot.date|ez_full_datetime }}</p>
                        <div class="ez-content-field-value">


                            <section class="ez-fieldgroup container">
                                <div class="ez-content-field">
                                    <p class="ez-content-field-name">Limit</p>
                                    <div class="ez-content-field-value">
                                        {{ snapshot.limit }}
                                    </div>
                                </div>
                            </section>
                            <section class="ez-fieldgroup container">
                                <div class="ez-content-field">
                                    <p class="ez-content-field-name">Slots</p>
                                    <div class="ez-content-field-value">
                                        {{ snapshot.slots|length }}
                                    </div>
                                </div>
                            </section>
                            <section class="ez-fieldgroup container">
                                <div class="ez-content-field">
                                    <p class="ez-content-field-name">Initial items ({{ snapshot.initialItems|length }})</p>
                                    <div class="ez-content-field-value">
                                        <table class="table  ">
                                            <thead>
                                            <tr>
                                                <th></th>
                                                <th>ID</th>
                                                <th>Addition date</th>
                                                <th>Content</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                {% for initial_item in snapshot.initialItems  %}
                                                    <tr>
                                                        <td class="ez-table__cell">
                                                            {{ loop.index }}
                                                        </td>
                                                        <td class="ez-table__cell">
                                                            {{ initial_item.id }}
                                                        </td>
                                                        <td class="ez-table__cell">
                                                            {{ initial_item.additionDate|ez_full_datetime }}
                                                        </td>
                                                        <td class="ez-table__cell">
                                                            {{ ez_content_name(initial_item.location.contentInfo) }}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </section>

                        </div>
                    </div>
                    {% endfor %}
                </section>
            </div>

        </section>
    {% endfor %}

{% endblock %}
